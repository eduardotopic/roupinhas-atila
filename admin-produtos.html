<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin - Produtos</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    .admin-wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }
    .admin-top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin: 10px 0 16px;
    }
    .pill{
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.12);
      background: #fff; cursor:pointer; font-weight: 800;
    }
    .btn-primary{ background: #111218; color:#fff; border: 1px solid rgba(255,255,255,.14); }
    .btn-danger{ background: #ffefef; border-color: rgba(255,0,0,.25); }
    .btn-ghost{ background: transparent; }
    .grid-admin{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width: 760px){
      .grid-admin{ grid-template-columns: 1fr 1fr; }
    }
    .card-admin{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .thumb{
      width: 92px; height: 92px; border-radius: 14px; object-fit: cover;
      background: rgba(255,255,255,.08);
      flex: 0 0 auto;
    }
    .meta{ flex: 1; min-width: 0; }
    .title{ font-weight: 900; margin: 0 0 4px; }
    .sub{ opacity:.75; font-size: 13px; margin: 0 0 8px; }
    .price{ font-weight: 900; margin: 0 0 10px; }
    .tag{
      display:inline-block;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      margin-right: 6px;
    }
    .tag.ok{ border-color: rgba(37,211,102,.35); }
    .tag.warn{ border-color: rgba(255,193,7,.35); }
    .tag.bad{ border-color: rgba(255,0,0,.35); }

    /* Login box */
    .loginBox{
      max-width: 520px; margin: 0 auto; padding: 16px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(255,255,255,.04);
    }
    .loginBox input{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: inherit;
      margin-top: 8px;
      outline:none;
    }
    .muted{ opacity:.75; font-size: 13px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="admin-wrap">
    <div class="admin-top">
      <div class="row">
        <a class="btn btn-ghost" href="./index.html" style="text-decoration:none;">← Voltar</a>
        <span class="pill">Admin</span>
        <span id="who" class="pill">Deslogado</span>
      </div>
      <div class="row">
        <button id="btnRefresh" class="btn">Atualizar</button>
        <button id="btnLogout" class="btn btn-danger hidden">Sair</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section id="loginSection" class="loginBox">
      <h2 style="margin:0 0 8px;">Login Admin</h2>
      <div class="muted">Entre com e-mail e senha do Firebase Authentication.</div>
      <input id="email" type="email" placeholder="Email" autocomplete="email" />
      <input id="pass" type="password" placeholder="Senha" autocomplete="current-password" />
      <div class="row" style="margin-top:12px;">
        <button id="btnLogin" class="btn btn-primary">Entrar</button>
      </div>
      <div id="loginErr" class="muted" style="margin-top:10px; color:#ffb4b4;"></div>
    </section>

    <!-- ADMIN LISTA -->
    <section id="adminSection" class="hidden">
      <h2 style="margin:0 0 12px;">Produtos</h2>
      <div class="muted" style="margin-bottom:12px;">
        Dica: “Vendido” continua visível aqui, mas some para clientes.
      </div>
      <div id="grid" class="grid-admin"></div>
    </section>
  </div>

<script type="module">
  import { db } from "./firebase.js";
  import {
    collection, getDocs, query, orderBy,
    doc, getDoc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const auth = getAuth();

  const elWho = document.getElementById("who");
  const loginSection = document.getElementById("loginSection");
  const adminSection = document.getElementById("adminSection");
  const grid = document.getElementById("grid");

  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const btnRefresh = document.getElementById("btnRefresh");

  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("pass");
  const loginErr = document.getElementById("loginErr");

  function moneyBR(v){
    const n = Number(v || 0);
    return `R$ ${n.toFixed(2).replace(".", ",")}`;
  }

  function statusTag(status){
    if (status === "disponivel") return `<span class="tag ok">disponível</span>`;
    if (status === "reservado") return `<span class="tag warn">reservado</span>`;
    if (status === "vendido") return `<span class="tag bad">vendido</span>`;
    return `<span class="tag">${status || "-"}</span>`;
  }

  function publicItemLink(id){
    // link público do item (GitHub pages)
    return `${location.origin}${location.pathname.replace("admin-produtos.html","")}item.html?id=${id}`;
  }

  async function assertAdmin(user){
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    return snap.exists() && snap.data()?.role === "admin";
  }

  async function loadProdutos(){
    grid.innerHTML = `<div class="muted">Carregando...</div>`;

    // Ordena pelo criadoEm se existir — senão, volta pelo __name__
    // Obs: se der erro de índice aqui, a gente cria igual ao do cliente
    const q = query(collection(db, "produtos"), orderBy("criadoEm", "desc"));
    const snap = await getDocs(q);

    const items = [];
    snap.forEach(d => items.push({ id: d.id, ...d.data() }));

    grid.innerHTML = "";
    if (items.length === 0){
      grid.innerHTML = `<div class="muted">Nenhum produto.</div>`;
      return;
    }

    items.forEach(p => {
      const fotos = Array.isArray(p.fotos) ? p.fotos.filter(Boolean) : [];
      const thumb = fotos[0] || "";
      const link = publicItemLink(p.id);

      const card = document.createElement("div");
      card.className = "card-admin";
      card.innerHTML = `
        ${thumb ? `<img class="thumb" src="${thumb}" alt="">` : `<div class="thumb"></div>`}
        <div class="meta">
          <div class="title">${p.titulo || "Produto"}</div>
          <div class="sub">${p.tamanho ? `Tam: ${p.tamanho}` : ""}</div>
          <div class="price">${moneyBR(p.preco)}</div>
          <div style="margin-bottom:10px;">${statusTag(p.status)}</div>

          <div class="row">
            <button class="btn" data-act="disponivel">Disponível</button>
            <button class="btn" data-act="reservado">Reservar</button>
            <button class="btn btn-danger" data-act="vendido">Vendido</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" data-act="copy">Copiar link</button>
            <a class="btn btn-ghost" href="${link}" target="_blank" rel="noopener" style="text-decoration:none;">Abrir público</a>
            <button class="btn btn-danger" data-act="delete">Excluir</button>
          </div>
        </div>
      `;

      card.addEventListener("click", async (e) => {
        const btn = e.target?.closest("button");
        if (!btn) return;

        const act = btn.getAttribute("data-act");
        const ref = doc(db, "produtos", p.id);

        try{
          if (act === "copy"){
            await navigator.clipboard.writeText(link);
            btn.textContent = "Copiado!";
            setTimeout(() => (btn.textContent = "Copiar link"), 900);
            return;
          }

          if (act === "delete"){
            const ok = confirm("Excluir esse produto? Não tem volta.");
            if (!ok) return;
            await deleteDoc(ref);
            card.remove();
            return;
          }

          if (act === "disponivel" || act === "reservado" || act === "vendido"){
            await updateDoc(ref, { status: act });
            // Atualiza tag na UI sem recarregar tudo
            const tagWrap = card.querySelector(".tag")?.parentElement;
            if (tagWrap) tagWrap.innerHTML = statusTag(act);
            return;
          }
        }catch(err){
          console.error(err);
          alert("Erro ao atualizar. Veja o Console (F12).");
        }
      });

      grid.appendChild(card);
    });
  }

  btnLogin.onclick = async () => {
    loginErr.textContent = "";
    const email = emailEl.value.trim();
    const pass = passEl.value.trim();
    if (!email || !pass){
      loginErr.textContent = "Preencha e-mail e senha.";
      return;
    }

    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      console.error(err);
      loginErr.textContent = "Login falhou. Verifique e-mail/senha.";
    }
  };

  btnLogout.onclick = async () => {
    await signOut(auth);
  };

  btnRefresh.onclick = async () => {
    if (!adminSection.classList.contains("hidden")) await loadProdutos();
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user){
      elWho.textContent = "Deslogado";
      loginSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
      btnLogout.classList.add("hidden");
      grid.innerHTML = "";
      return;
    }

    elWho.textContent = user.email || user.uid;

    // Checa admin via Firestore users/{uid}.role
    let isAdmin = false;
    try{
      isAdmin = await assertAdmin(user);
    }catch(err){
      console.error(err);
    }

    if (!isAdmin){
      alert("Seu usuário não é admin (users/{uid}.role != 'admin').");
      await signOut(auth);
      return;
    }

    loginSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    btnLogout.classList.remove("hidden");

    await loadProdutos();
  });
</script>
</body>
</html>
