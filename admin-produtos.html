<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin ¬∑ Produtos</title>

  <style>
    :root{
      --bg:#0b0b10;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.14);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --danger:#ff5a7a;
      --ok:#34d399;
      --radius:18px;
      --shadow:0 20px 60px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(167,139,250,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 600px at 40% 100%, rgba(52,211,153,.12), transparent 60%),
        var(--bg);
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
      display:grid;
      place-items:start center;
    }

    .wrap{ width:min(520px, 100%); padding:14px; }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin: 8px 6px 14px;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      width:40px;
      height:40px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      border:1px solid var(--border);
      display:grid;
      place-items:center;
      font-size:20px;
    }

    h1{ font-size:18px; margin:0; }
    .sub{ font-size:12px; color:var(--muted); }

    .btn-ghost{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:12px 2px 6px;
    }

    input, select, textarea{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    textarea{ min-height:90px; resize:vertical; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    @media (max-width:420px){
      .grid{ grid-template-columns:1fr; }
    }

    .upload{
      margin-top:8px;
      padding:12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color: rgba(255,255,255,.55);
      line-height: 1.35;
    }

    .previews{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }

    .preview{
      height:90px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      position: relative;
    }

    .preview img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .progress{
      margin-top: 10px;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      display:none;
    }
    .bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .btn{
      width:100%;
      margin-top:14px;
      padding:14px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      font-weight:800;
      font-size:16px;
      color:#0b0b10;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; }

    .msg{
      margin-top:12px;
      font-size:13px;
      min-height:18px;
      color:var(--muted);
    }
    .msg.err{ color:var(--danger); }
    .msg.ok{ color:var(--ok); }

    .footer{
      margin-top:12px;
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.45);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="badge">üß∫</div>
        <div>
          <h1>Novo produto</h1>
          <div class="sub">Cadastro (admin)</div>
        </div>
      </div>
      <button id="logout" class="btn-ghost">Sair</button>
    </div>

    <div class="card">
      <label>T√≠tulo</label>
      <input id="titulo" placeholder="Ex: Body azul" />

      <div class="grid">
        <div>
          <label>Pre√ßo (R$)</label>
          <input id="preco" type="number" step="0.01" placeholder="39.90" />
        </div>
        <div>
          <label>Tamanho</label>
          <input id="tamanho" placeholder="Ex: 2 anos" />
        </div>
      </div>

      <label>Status</label>
      <select id="status">
        <option value="disponivel">Dispon√≠vel</option>
        <option value="reservado">Reservado</option>
        <option value="vendido">Vendido</option>
      </select>

      <label>Fotos (1 a 3)</label>
      <div class="upload">
        <input id="fotoFiles" type="file" accept="image/*" multiple />
        <div class="hint">No celular: selecione da galeria ou use a c√¢mera. M√°x. 3 fotos.</div>
        <div class="previews" id="previews"></div>

        <div class="progress" id="progress">
          <div class="bar" id="bar"></div>
        </div>
      </div>

      <label>Descri√ß√£o</label>
      <textarea id="descricao" placeholder="Observa√ß√µes sobre o produto"></textarea>

      <button id="salvar" class="btn">Salvar produto</button>
      <div id="msg" class="msg"></div>
    </div>

    <div class="footer">Roupinhas do √Åtila ¬∑ Admin</div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const $ = (id) => document.getElementById(id);

    const fotoFiles = $("fotoFiles");
    const previews = $("previews");
    const msg = $("msg");
    const progress = $("progress");
    const bar = $("bar");
    const btnSalvar = $("salvar");

    const storage = getStorage();

    let currentUser = null;
    let isAdmin = false;

    function setMsg(text, kind="") {
      msg.className = "msg" + (kind ? " " + kind : "");
      msg.textContent = text || "";
    }
    function setProgress(pct) {
      progress.style.display = "block";
      bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }
    function resetProgress() {
      progress.style.display = "none";
      bar.style.width = "0%";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "admin.html";
        return;
      }
      currentUser = user;

      const snap = await getDoc(doc(db, "users", user.uid));
      isAdmin = snap.exists() && snap.data().role === "admin";
      if (!isAdmin) setMsg("Usu√°rio n√£o √© admin.", "err");
    });

    $("logout").onclick = async () => {
      await signOut(auth);
      location.href = "admin.html";
    };

    fotoFiles.addEventListener("change", () => {
      previews.innerHTML = "";
      const files = Array.from(fotoFiles.files || []);
      if (files.length > 3) {
        alert("Escolha no m√°ximo 3 fotos.");
        fotoFiles.value = "";
        return;
      }
      files.forEach(file => {
        const div = document.createElement("div");
        div.className = "preview";
        div.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="foto">`;
        previews.appendChild(div);
      });
    });

    function safeFileExt(file) {
      const t = (file.type || "").toLowerCase();
      if (t.includes("png")) return "png";
      if (t.includes("webp")) return "webp";
      return "jpg";
    }

    async function uploadFotos(productId, files) {
      // Upload sequencial (mais simples e confi√°vel) com progresso agregado
      const urls = [];
      let done = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Nome est√°vel + √∫nico
        const ext = safeFileExt(file);
        const fileName = `foto_${i+1}_${Date.now()}.${ext}`;

        // Caminho protegido por regras (s√≥ admin escreve)
        const path = `produtos/${productId}/${fileName}`;
        const ref = storageRef(storage, path);

        await new Promise((resolve, reject) => {
          const task = uploadBytesResumable(ref, file, {
            contentType: file.type || "image/jpeg",
            cacheControl: "public,max-age=31536000"
          });

          task.on("state_changed",
            (snap) => {
              // progresso total aproximado: m√©dia entre arquivos
              const pctThis = (snap.bytesTransferred / snap.totalBytes) * 100;
              const pctTotal = ((done + (pctThis/100)) / files.length) * 100;
              setProgress(pctTotal);
            },
            (err) => reject(err),
            async () => {
              const url = await getDownloadURL(task.snapshot.ref);
              urls.push(url);
              done += 1;
              setProgress((done / files.length) * 100);
              resolve();
            }
          );
        });
      }

      return urls;
    }

    btnSalvar.onclick = async () => {
      setMsg("");
      resetProgress();
      btnSalvar.disabled = true;

      try {
        if (!currentUser) { setMsg("Fa√ßa login novamente.", "err"); return; }
        if (!isAdmin) { setMsg("Sem permiss√£o de admin.", "err"); return; }

        const titulo = $("titulo").value.trim();
        const preco = Number($("preco").value);
        const tamanho = $("tamanho").value.trim();
        const statusVal = $("status").value;
        const descricao = $("descricao").value.trim();

        if (!titulo) { setMsg("Informe o t√≠tulo.", "err"); return; }
        if (!Number.isFinite(preco) || preco <= 0) { setMsg("Informe um pre√ßo v√°lido.", "err"); return; }
        if (!tamanho) { setMsg("Informe o tamanho.", "err"); return; }

        const files = Array.from(fotoFiles.files || []);
        if (files.length === 0) { setMsg("Selecione pelo menos 1 foto.", "err"); return; }
        if (files.length > 3) { setMsg("M√°ximo 3 fotos.", "err"); return; }

        // 1) cria o produto primeiro (pra ter productId)
        setMsg("Criando produto‚Ä¶");
        const docRef = await addDoc(collection(db, "produtos"), {
          titulo,
          preco,
          tamanho,
          status: statusVal,
          descricao: descricao || null,
          fotos: [], // vamos atualizar com URLs ap√≥s upload (mantemos consistente)
          criadoEm: serverTimestamp()
        });

        // 2) sobe fotos e pega URLs
        setMsg("Enviando fotos‚Ä¶");
        const urls = await uploadFotos(docRef.id, files);

        // 3) atualiza o documento com as URLs (sem precisar de update import extra: faz via addDoc? N√£o.)
        // Vamos importar updateDoc.
        // (Hack limpo: import din√¢mico)
        const { updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await updateDoc(doc(db, "produtos", docRef.id), { fotos: urls });

        setMsg("Produto salvo com fotos ‚úÖ", "ok");
        resetProgress();

        // limpa campos
        $("titulo").value = "";
        $("preco").value = "";
        $("tamanho").value = "";
        $("status").value = "disponivel";
        $("descricao").value = "";
        fotoFiles.value = "";
        previews.innerHTML = "";

      } catch (e) {
        console.error(e);
        setMsg("Erro ao subir fotos/salvar. Veja o console.", "err");
      } finally {
        btnSalvar.disabled = false;
      }
    };
  </script>
</body>
</html>
