<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin ¬∑ Produtos</title>

  <style>
    :root{
      --bg:#0b0b10;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.14);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --danger:#ff5a7a;
      --ok:#34d399;
      --radius:18px;
      --shadow:0 20px 60px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(167,139,250,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 600px at 40% 100%, rgba(52,211,153,.12), transparent 60%),
        var(--bg);
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
      display:grid;
      place-items:start center;
    }
    .wrap{ width:min(520px, 100%); padding: 14px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin: 8px 6px 14px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      width: 40px; height: 40px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-size: 20px;
    }
    h1{ font-size: 18px; margin:0; }
    .sub{ margin:2px 0 0; font-size: 12px; color: var(--muted); }

    .btn-ghost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 700;
      cursor:pointer;
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    label{ display:block; font-size: 13px; color: var(--muted); margin: 12px 2px 6px; }
    input, select, textarea{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size: 16px; /* iOS no-zoom */
    }
    textarea{ min-height: 90px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 4px rgba(110,231,255,.12);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 420px){
      .grid{ grid-template-columns: 1fr; }
    }

    .upload{
      display:flex;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      margin-top: 10px;
    }
    .preview{
      width: 74px;
      height: 74px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow:hidden;
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      font-size: 22px;
      color: rgba(255,255,255,.5);
    }
    .preview img{ width:100%; height:100%; object-fit: cover; display:block; }
    .upload-actions{ flex: 1; }
    .small{ font-size: 12px; color: rgba(255,255,255,.55); margin-top: 4px; line-height:1.35; }

    .btn{
      width: 100%;
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 0;
      cursor: pointer;
      font-weight: 800;
      font-size: 16px;
      color: rgba(10,10,14,.95);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 40px rgba(110,231,255,.14);
      transition: transform .06s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; }

    .msg{ margin-top: 12px; font-size: 13px; color: var(--muted); min-height: 18px; }
    .msg.err{ color: var(--danger); }
    .msg.ok{ color: var(--ok); }

    .footer{
      margin-top: 12px;
      text-align:center;
      color: rgba(255,255,255,.45);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="badge">üß∫</div>
        <div>
          <h1>Novo produto</h1>
          <div class="sub">Cadastro r√°pido (admin)</div>
        </div>
      </div>
      <button id="logout" class="btn-ghost">Sair</button>
    </div>

    <div class="card">
      <label for="titulo">T√≠tulo</label>
      <input id="titulo" placeholder="Ex: Body azul" />

      <div class="grid">
        <div>
          <label for="preco">Pre√ßo (R$)</label>
          <input id="preco" type="number" inputmode="decimal" step="0.01" placeholder="35" />
        </div>
        <div>
          <label for="tamanho">Tamanho</label>
          <input id="tamanho" placeholder='Ex: "2 anos"' />
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option value="disponivel">Dispon√≠vel</option>
            <option value="reservado">Reservado</option>
            <option value="vendido">Vendido</option>
          </select>
        </div>
        <div>
          <label for="categoria">Categoria (opcional)</label>
          <input id="categoria" placeholder="Ex: bodies" />
        </div>
      </div>

      <label>Foto (tirar ou escolher)</label>
      <div class="upload">
        <div class="preview" id="previewBox">üì∑</div>
        <div class="upload-actions">
          <!-- iPhone/Android normalmente oferece C√¢mera ou Galeria -->
          <input id="fotoFile" type="file" accept="image/*" capture="environment" />
          <div class="small">
            Dica: se voc√™ tocar no campo acima, no celular geralmente aparece ‚ÄúTirar foto‚Äù ou ‚ÄúBiblioteca‚Äù.
          </div>
        </div>
      </div>

      <label for="descricao">Descri√ß√£o</label>
      <textarea id="descricao" placeholder='Ex: "Pouco usado, √≥timo estado"'></textarea>

      <button id="salvar" class="btn">Salvar produto</button>
      <div id="msg" class="msg"></div>
    </div>

    <div class="footer">Roupinhas do √Åtila ¬∑ Admin</div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    const previewBox = $("previewBox");
    const fotoFile = $("fotoFile");
    const msg = $("msg");
    const btn = $("salvar");

    let currentUser = null;
    let isAdmin = false;

    function setMsg(text, kind="") {
      msg.className = "msg" + (kind ? " " + kind : "");
      msg.textContent = text || "";
    }

    // Protege a p√°gina (s√≥ admin)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "admin.html";
        return;
      }
      currentUser = user;

      // checa role
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      isAdmin = snap.exists() && snap.data().role === "admin";

      if (!isAdmin) {
        setMsg("Seu usu√°rio n√£o √© admin.", "err");
      }
    });

    // Logout
    $("logout").onclick = async () => {
      await signOut(auth);
      location.href = "admin.html";
    };

    // Preview da foto
    fotoFile.addEventListener("change", () => {
      const file = fotoFile.files && fotoFile.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      previewBox.innerHTML = `<img src="${url}" alt="preview">`;
    });

    // ‚úÖ Por enquanto: salva produto no Firestore com fotos: [] (sem upload)
    // Isso mant√©m o app em produ√ß√£o SEM precisar Storage ainda.
    btn.onclick = async () => {
      setMsg("");
      btn.disabled = true;

      try {
        if (!currentUser) {
          setMsg("Fa√ßa login novamente.", "err");
          return;
        }
        if (!isAdmin) {
          setMsg("Voc√™ n√£o tem permiss√£o de admin.", "err");
          return;
        }

        const titulo = $("titulo").value.trim();
        const preco = Number($("preco").value);
        const tamanho = $("tamanho").value.trim();
        const statusVal = $("status").value;
        const categoria = $("categoria").value.trim();
        const descricao = $("descricao").value.trim();

        if (!titulo) { setMsg("Informe o t√≠tulo.", "err"); return; }
        if (!Number.isFinite(preco) || preco <= 0) { setMsg("Informe um pre√ßo v√°lido.", "err"); return; }

        // Foto: por enquanto n√£o fazemos upload. Guardamos placeholder.
        // Pr√≥ximo passo (que eu fa√ßo com voc√™): upload no Firebase Storage e salvar a URL.
        const file = fotoFile.files && fotoFile.files[0];
        const fotos = [];
        if (file) {
          fotos.push("PENDENTE_UPLOAD_STORAGE");
        }

        await addDoc(collection(db, "produtos"), {
          titulo,
          preco,
          tamanho,
          status: statusVal,
          categoria: categoria || null,
          descricao: descricao || null,
          fotos,
          criadoEm: serverTimestamp()
        });

        setMsg("Produto salvo no Firestore ‚úÖ", "ok");

        // limpa campos
        $("titulo").value = "";
        $("preco").value = "";
        $("tamanho").value = "";
        $("status").value = "disponivel";
        $("categoria").value = "";
        $("descricao").value = "";
        fotoFile.value = "";
        previewBox.textContent = "üì∑";

      } catch (e) {
        console.error(e);
        setMsg("Erro ao salvar. Veja o console.", "err");
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
